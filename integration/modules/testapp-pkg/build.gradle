import com.apgsga.gradle.repo.extensions.RepoType
import com.apgsga.revision.manager.domain.RevisionManagerBuilder
plugins {
	id("com.apgsga.rpm.package")
	id("com.apgsga.publish")
	id("com.apgsga.rpm.ssh.deployer")
	id("com.apgsga.version.resolver")
}

project.ext {
	targetHost = project.hasProperty('targetHost') ? project.property('targetHost') : "jadas-e.apgsga.ch"
	sshUser = project.hasProperty('sshUser') ? project.property('sshUser') : "deployUser"
	sshPw = project.hasProperty('sshPw') ? project.property('sshPw') : "deployUserPassword"
	installTarget = project.hasProperty('installTarget') ? project.property('installTarget') : "CHEI212"
	baseVersion = project.hasProperty('baseVersion') ? project.property('baseVersion') : "1.0"
	bomLastRevision = project.hasProperty('bomLastRevision') ? project.property('bomLastRevision') : "SNAPSHOT"
	patchParentDir = project.hasProperty('patchParentDir') ? project.property('patchParentDir') : project.buildDir.absolutePath
	patchFileNames = project.hasProperty('patchFileNames') ? project.property('patchFileNames') : ""
	revisionRootPath = project.hasProperty('revisionRootPath') ? project.property('revisionRootPath') : project.buildDir.absolutePath
	rpmReleaseNr = project.hasProperty('rpmReleaseNr') ? project.property('rpmReleaseNr') : "2"
	downloadDir = project.hasProperty('downloadDir') ? project.property('downloadDir') : "downloads"
}
println "targetHost = ${project.ext.targetHost}"
println "installTarget = ${project.ext.installTarget}"
println "baseVersion = ${project.ext.baseVersion}"
println "bomLastRevision = ${project.ext.bomLastRevision}"
println "rpmReleaseNr = ${project.ext.rpmReleaseNr}"
println "downloadDir = ${project.ext.downloadDir}"

apply from : "${project.gradle.gradleUserHomeDir}/../git/apg-gradle-properties/common/portnr.gradle"

configurations {
	serviceRuntime.exclude group: 'log4j', module: 'log4j'
	serviceRuntime.exclude group: 'org.neo4j' , module: 'neo4j-ogm'
	serviceRuntime.exclude group: 'org.neo4j' , module: 'neo4j-ogm'
	serviceRuntime.exclude group: 'org.codehaus.groovy' , module: 'groovy-all'
}

apgRepos {
	// TODO (che, 27.2) : Profiles needed
	config(RepoType.MAVEN,[REPO_NAME:"testrepo",REPO_BASE_URL:"/Users/chhex/maven"])
	config(RepoType.MAVEN_RELEASE,[REPO_NAME:"repo", REPO_BASE_URL:"https://artifactory4t4apgsga.jfrog.io/artifactory4t4apgsga",REPO_USER:"dev",REPO_PASSWORD:credentials.devPw])
	config(RepoType.MAVEN_SNAPSHOT,[REPO_NAME:"snapshot", REPO_BASE_URL:"https://artifactory4t4apgsga.jfrog.io/artifactory4t4apgsga",REPO_USER:"dev",REPO_PASSWORD:credentials.devPw])
}

apgRepositories {
	mavenLocal()
	artifactory()
}


apgVersionResolver {
	bomArtifactId = 'dm-bom'
	bomGroupId = 'com.apgsga.testapp'
	bomBaseVersion = project.ext.baseVersion
	bomLastRevision =  project.ext.bomLastRevision
	installTarget = project.ext.installTarget
	persistence =  RevisionManagerBuilder.PersistenceTyp.BEANS
	algorithm =  RevisionManagerBuilder.AlgorithmTyp.SNAPSHOT
	patches {
		parentDir = project.ext.patchParentDir
		fileNames = project.ext.patchFileNames
	}
	revisionRootPath = project.buildDir.absolutePath
}




apgPackage {
	serviceName = 'echoservice'
	configurationName = "serviceRuntime"
	dependencies = [
		"com.apgsga.testapp:testapp-service"
    ]
	resourceFilters = "serviceport"
	appConfigFilters = "general"
  	servicePropertiesDir = "resources"
	installTarget = project.ext.installTarget
	mainProgramName  = "com.apgsga.testapp.TestappApplication"
	releaseNr = project.ext.rpmReleaseNr
}

apgPackage.log()

apgPackage.listPortNumbers()

apgGenericPublishConfig {
	artefactFile =  file ("${buildDir}/distributions/${apgPackage.archiveName}")
	local()
}



apgGenericPublishConfig.log()

apgSshCommon {
	username credentials."${project.ext.sshUser}"
	userpwd credentials."${project.ext.sshPw}"
	destinationHost project.ext.targetHost

}

apgRpmDeployConfig {
	allowAnyHosts = true
	rpmFilePath "${buildDir}/distributions/"
	rpmFileName "${apgPackage.archiveName}"
	remoteDestFolder "${project.ext.downloadDir}"
}

 