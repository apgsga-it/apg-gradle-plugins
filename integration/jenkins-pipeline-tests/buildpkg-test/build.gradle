plugins {
    id 'com.palantir.docker-run' version '0.24.0'
    id 'java'
}
def modulesToTestDir = "../../modules"
def localMaven

repositories {
    localMaven = mavenLocal()
    mavenCentral()
}

println "Maven Local Repo : ${localMaven.url.path}"

dockerRun {
    name 'buildpkg-test'
    image 'apg-jenkinsrunner-image:latest'
    volumes 'src/jenkins/Jenkinsfile': '/workspace/Jenkinsfile',
            'jenkinsHome': '/jenkinsHome',  "${modulesToTestDir}": '/jenkinsWorkspace' ,
            "${localMaven.url.path}":'/mavenLocal', "${gradle.gradleUserHomeDir}":'/gradleUserHome'
    daemonize false
    clean true
    command '--runWorkspace', '/jenkinsWorkspace', '--runHome', '/jenkinsHome',
            '-a', 'modules=testapp-bom:testapp-parentpom:testapp-module:testapp-service',
            '-a', 'versionNr=2.0',  '-a', 'releaseNr=10',   '-a', 'installTarget=CHTI211'
}

task cleanJenkinsHome(type: Delete) {
    fileTree(dir: 'jenkinsHome').visit { FileVisitDetails details ->
        delete details.file
    }
}

clean.dependsOn cleanJenkinsHome