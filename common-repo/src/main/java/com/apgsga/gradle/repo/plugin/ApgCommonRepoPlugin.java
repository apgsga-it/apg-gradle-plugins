/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package com.apgsga.gradle.repo.plugin;

import com.apgsga.gradle.repo.extensions.ReposImpl;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.gradle.api.NonNullApi;
import org.gradle.api.Plugin;
import org.gradle.api.Project;
import org.gradle.api.plugins.ExtensionContainer;
import org.springframework.core.io.FileSystemResourceLoader;
import org.springframework.core.io.Resource;
import org.springframework.util.Assert;

import java.io.File;
import java.io.IOException;

@NonNullApi
public class ApgCommonRepoPlugin implements Plugin<Project> {

	public static final String COMMMON_REPO_PLUGIN_NAME = "apgRepos";

	private static final String REPO_NAMES_JSON_FILENAME = "repoNames.json";

	private Project project;

	@Override
	public void apply(final Project project) {
		this.project = project;
		final ExtensionContainer ext = project.getExtensions();
		ext.create(COMMMON_REPO_PLUGIN_NAME, ReposImpl.class, project, getRepositories());
	}

	// TODO JHE: rename method
	private ReposImpl getRepositories() {
		ReposImpl r = null;
		try {
			r = new ObjectMapper().readerFor(ReposImpl.class).readValue(getRepoNameResource().getInputStream());
		} catch (IOException e) {
			e.printStackTrace();
		}
		return r;
	}

	private Resource getRepoNameResource() {
		String gradleHome = project.getGradle().getGradleUserHomeDir().getAbsolutePath();
		FileSystemResourceLoader loader = new FileSystemResourceLoader();
		String repoNamesJsonFilePath = gradleHome + File.separator + REPO_NAMES_JSON_FILENAME;
		Resource repoNamesJsonAsResource = loader.getResource(repoNamesJsonFilePath);
		Assert.isTrue(repoNamesJsonAsResource.exists(), REPO_NAMES_JSON_FILENAME + " file not found! repoNamesJsonFilePath = " + repoNamesJsonFilePath);
		return repoNamesJsonAsResource;
	}
}